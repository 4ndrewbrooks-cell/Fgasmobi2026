<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FGas Service Tool</title>

<meta http-equiv="Content-Security-Policy-Report-Only" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self';">

<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js" integrity="sha384-MTDrIlFOzEqpmOxY6UIA/1Zkh0a64UlmJ6R0UrZXqXCPx99siPGi8EmtQjIeCcTH" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk" crossorigin="anonymous"></script>

<style>
:root{
  --bg:#0b1724;
  --card:#111827;
  --accent:#0ea5e9;
  --accent-soft:rgba(14,165,233,0.14);
  --accent-danger:#f97373;
  --text:#f9fafb;
  --muted:#9ca3af;
  --border:#1f2937;
  --radius:14px;
  --shadow:0 18px 45px rgba(0,0,0,0.4);
  --spacing:12px;
  --input-bg:#020617;
}
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top, #1e293b 0, #020617 46%, #000 100%);
  margin:0;
  padding:var(--spacing);
  color:var(--text);
}
.app-shell{
  max-width:1120px;
  margin:0 auto 40px auto;
}
.app-header{
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-bottom:10px;
}
.app-header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
}
h1{
  margin:0;
  font-size:22px;
  letter-spacing:.02em;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 8px;
  border-radius:999px;
  background:rgba(15,23,42,0.9);
  border:1px solid rgba(148,163,184,0.22);
  font-size:11px;
  color:var(--muted);
}
.badge-dot{
  width:7px;
  height:7px;
  border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 4px rgba(34,197,94,0.3);
}
.small{font-size:12px;color:var(--muted)}
.small-muted{font-size:12px;color:var(--muted)}

.wrap{
  display:flex;
  flex-direction:column;
  gap:var(--spacing);
}
.sidebar,
.panel{
  width:100%;
}
.card{
  background:linear-gradient(135deg,#020617,#020617 40%,#020617 60%,#020617);
  border-radius:var(--radius);
  padding:10px 12px 12px 12px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}
.card h2{
  margin:0 0 4px 0;
  font-size:15px;
  letter-spacing:.03em;
  text-transform:uppercase;
  color:var(--muted);
}
.card h3{
  margin:4px 0 6px 0;
  font-size:14px;
}
.card-sub{
  font-size:11px;
  color:var(--muted);
}

input,textarea,select{
  width:100%;
  padding:8px 9px;
  margin:5px 0;
  border-radius:10px;
  border:1px solid #1f2937;
  background:var(--input-bg);
  color:var(--text);
  font-size:13px;
  outline:none;
  transition:border-color .15s,box-shadow .15s,background .15s;
}
input:focus,textarea:focus,select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(14,165,233,0.35);
  background:#020617;
}
textarea{min-height:80px;resize:vertical}

button{
  padding:7px 10px;
  border-radius:999px;
  border:1px solid #1e293b;
  background:#020617;
  color:var(--text);
  font-size:12px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
  transition:background .15s,border-color .15s,transform .08s,box-shadow .12s;
}
button:hover{
  background:#020617;
  border-color:#334155;
}
button:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.45) inset;
}
.btn-primary{
  background:linear-gradient(135deg,#0ea5e9,#38bdf8);
  border-color:#0ea5e9;
  color:#0b1120;
  font-weight:600;
  box-shadow:0 10px 25px rgba(56,189,248,0.35);
}
.btn-primary:hover{
  background:linear-gradient(135deg,#38bdf8,#0ea5e9);
}
.btn-danger{
  background:linear-gradient(135deg,#f97373,#ef4444);
  border-color:#f97373;
  color:#111827;
}
.btn-pill{
  padding-inline:14px;
}
.chip{
  padding:3px 8px;
  border-radius:999px;
  border:1px solid #1f2937;
  background:#020617;
  font-size:11px;
  color:var(--muted);
}

.flex{display:flex;gap:8px}
.flex-wrap{flex-wrap:wrap}
.controls{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.list-item{
  padding:7px 9px;
  border-radius:10px;
  background:rgba(15,23,42,0.96);
  border:1px solid #1f2937;
  margin-bottom:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:border-color .15s,background .15s,transform .08s;
}
.list-item:hover{
  border-color:#4b5563;
  background:rgba(15,23,42,0.99);
  transform:translateY(-1px);
}

.unit{
  background:rgba(15,23,42,0.96);
  padding:8px 9px;
  border-radius:12px;
  margin-bottom:7px;
  border:1px solid #1f2937;
}
.unit-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
}
.unit-type-pill{
  padding:2px 8px;
  border-radius:999px;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.06em;
  border:1px solid #1d4ed8;
  background:rgba(37,99,235,0.18);
  color:#bfdbfe;
}
.unit-body{
  display:flex;
  gap:8px;
  margin-top:6px;
}
.unit-col{
  flex:1;
}
.note{
  font-size:11px;
  color:var(--muted);
}
.note strong{color:#e5e7eb}
.flag{
  color:#f97373;
  font-weight:600;
}

.logo-preview{
  max-width:110px;
  max-height:50px;
  display:block;
  margin-bottom:4px;
  border-radius:6px;
}

/* sticky-ish section titles on mobile for context */
.section-label{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:#6b7280;
  margin:8px 0 4px 0;
}

/* PDF hint bar */
.pdf-hint{
  font-size:11px;
  color:var(--muted);
  padding:5px 8px;
  border-radius:999px;
  background:rgba(15,23,42,0.9);
  border:1px dashed #1f2937;
}

/* Responsive layout */
@media (min-width:820px){
  .wrap{
    flex-direction:row;
    align-items:flex-start;
  }
  .sidebar{
    max-width:290px;
  }
  .panel{
    flex:1;
  }
}

/* tighten headings inside cards on mobile */
@media (max-width:480px){
  .card{
    padding:9px 10px 10px 10px;
  }
  h1{
    font-size:18px;
  }
}

/* simple scroll for long panels on small screens */
#mainContent{
  max-height:calc(100vh - 110px);
  overflow:auto;
}

/* subtle horizontal rule */
hr{
  border:none;
  border-top:1px solid #1f2937;
  margin:10px 0 8px 0;
}

/* toggle sections visual */
.settings-section-title{
  margin-top:4px;
  margin-bottom:4px;
  font-size:12px;
  font-weight:600;
  color:#e5e7eb;
}
</style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="app-header-row">
      <div>
        <h1>FGas Service Tool</h1>
        <div class="small">Locally stored F‑Gas service records with detailed PDF output.</div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>Offline first · JSON backup</span>
      </div>
    </div>
    <div class="app-header-row">
      <div class="pdf-hint">Tip: Save your engineer and company details once, then generate professional PDFs directly on site.</div>
      <button class="btn-pill" onclick="openUserSettings()">Engineer &amp; Company</button>
    </div>
  </header>
</div>

<div class="app-shell wrap">
  <aside class="sidebar">
    <div class="card">
      <h2>Businesses</h2>
      <div class="card-sub">Sites or clients you look after.</div>
      <div id="businessList" style="margin-top:6px"></div>
      <div style="margin-top:8px">
        <span class="section-label">Add business</span>
        <input id="newBusinessName" placeholder="Business name">
        <button class="btn-primary btn-pill" onclick="addBusiness()">Add Business</button>
      </div>
    </div>

    <div class="card">
      <h2>Export / Import</h2>
      <div class="card-sub">Backup to JSON or restore onto a new device.</div>
      <div style="margin-top:8px" class="flex flex-wrap">
        <button class="btn-pill" onclick="exportJSON()">Download JSON</button>
        <input id="importFile" type="file" accept="application/json">
        <button class="btn-pill" onclick="importJSON()">Import</button>
      </div>
    </div>
  </aside>

  <main class="panel">
    <div id="mainContent" class="card">
      <div id="emptyMsg" class="small-muted">Select or create a business to get started.</div>

      <div id="businessView" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
          <div>
            <div class="section-label">Current business</div>
            <h2 id="businessTitle" style="margin-bottom:2px"></h2>
            <div class="small-muted" id="businessInfo"></div>
            <div class="small-muted" id="businessContact"></div>
            <div class="small-muted" id="businessEngineer"></div>
          </div>
          <div style="text-align:right">
            <div id="businessLogoWrap"></div>
          </div>
        </div>

        <div style="margin-top:8px" class="controls">
          <button id="bizSettingsBtn" class="btn-pill" onclick="openBusinessSettings()">Business details</button>
        </div>

        <hr>
        <h3>Buildings</h3>
        <div id="buildingList"></div>

        <div style="margin-top:8px">
          <span class="section-label">Add building</span>
          <input id="newBuildingName" placeholder="Building name or site description">
          <button class="btn-primary btn-pill" onclick="addBuilding()">Add Building</button>
        </div>

        <hr>
        <div id="buildingView" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
            <div>
              <div class="section-label">Selected building</div>
              <h3 id="buildingTitle" style="margin-bottom:3px"></h3>
              <div class="small-muted" id="buildingInfo"></div>
            </div>
            <div class="controls">
              <button class="btn-pill" onclick="exportServiceReportPDF()">Service sheet PDF</button>
              <button class="btn-pill" onclick="exportFGasCertificatePDF()">F‑Gas cert PDF</button>
              <button class="btn-pill" onclick="openBuildingSettings()">Customer details</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <div style="flex:1;min-width:260px" class="card">
              <h3>Outdoor Units</h3>
              <div id="outdoorList"></div>
              <h4 style="margin-top:8px;margin-bottom:4px">Add outdoor unit</h4>
              <div>
                <input id="out_asset" placeholder="Asset number">
                <input id="out_location" placeholder="Location (roof, plant room, etc.)">
                <input id="out_model" placeholder="Model">
                <input id="out_serial" placeholder="Serial">
                <input id="out_acType" placeholder="System type (VRF, split, etc.)">
                <select id="out_refrigerant">
                  <option value="">Refrigerant</option>
                  <option>R22</option>
                  <option>R407</option>
                  <option>R410A</option>
                  <option>R32</option>
                </select>
                <input id="out_kg" placeholder="Charge (kg, e.g. 2.5)" type="number" step="any" min="0">
                <div class="flex">
                  <input id="out_airOn" placeholder="Air ON °C" type="number" step="any">
                  <input id="out_airOff" placeholder="Air OFF °C" type="number" step="any">
                </div>
                <div class="small-muted">Service frequency is set per building in customer details.</div>

                <div class="flex" style="align-items:flex-start;margin-top:4px">
                  <label style="display:flex;align-items:center;font-size:12px">
                    <input id="out_tick" type="checkbox" style="margin-right:6px">Flag issue
                  </label>
                  <select id="out_status">
                    <option value="">Status</option>
                    <option>Pass</option>
                    <option>Fail</option>
                  </select>
                </div>
                <textarea id="out_note" placeholder="Notes / Work carried out"></textarea>
                <div style="margin-top:6px">
                  <button class="btn-primary btn-pill" onclick="addUnit('outdoor')">Save outdoor unit</button>
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:260px" class="card">
              <h3>Indoor Units</h3>
              <div id="indoorList"></div>
              <h4 style="margin-top:8px;margin-bottom:4px">Add indoor unit</h4>
              <div>
                <input id="in_asset" placeholder="Asset number">
                <input id="in_location" placeholder="Location (room, office, etc.)">
                <input id="in_model" placeholder="Model">
                <input id="in_serial" placeholder="Serial">
                <input id="in_acType" placeholder="Unit type (cassette, ducted, etc.)">
                <div>
                  <label class="small-muted">Linked outdoor unit</label>
                  <select id="in_linkedOutdoor">
                    <option value="">None</option>
                  </select>
                </div>
                <div class="flex">
                  <input id="in_airOn" placeholder="Air ON °C" type="number" step="any">
                  <input id="in_airOff" placeholder="Air OFF °C" type="number" step="any">
                </div>
                <div class="small-muted">Service frequency is set per building in customer details.</div>

                <div class="flex" style="align-items:flex-start;margin-top:4px">
                  <label style="display:flex;align-items:center;font-size:12px">
                    <input id="in_tick" type="checkbox" style="margin-right:6px">Flag issue
                  </label>
                  <select id="in_status">
                    <option value="">Status</option>
                    <option>Pass</option>
                    <option>Fail</option>
                  </select>
                </div>
                <textarea id="in_note" placeholder="Notes / Work carried out"></textarea>
                <div style="margin-top:6px">
                  <button class="btn-primary btn-pill" onclick="addUnit('indoor')">Save indoor unit</button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px; display:none" class="small-muted">
  CO2e = refrigerant kg × GWP. Service rules: CO2e = 0 → 1/year. Otherwise:
  &lt;1,000 → 1/year, 1,000–4,999 → 2/year, 5,000–9,999 → 3/year, ≥10,000 → 4/year.
</div>
        </div>
      </div>

      <!-- Business settings -->
      <div id="businessSettings" style="display:none" class="card">
        <h2>Business details</h2>
        <div class="card-sub">Information that appears on service sheets for this client.</div>
        <div>
          <div class="settings-section-title">Basic information</div>
          <label>Business name</label>
          <input id="biz_name">
          <label>Contact details</label>
          <input id="biz_contact" placeholder="Phone / Email">
          <label>Preferred engineer</label>
          <input id="biz_engineer" placeholder="Engineer">

          <div class="settings-section-title" style="margin-top:6px">Branding</div>
          <label>Logo (PNG/JPG)</label>
          <input id="biz_logo_file" type="file" accept="image/*">
          <img id="biz_logo_preview" class="logo-preview" style="display:none">
        </div>

        <div style="margin-top:10px" class="controls">
          <button class="btn-primary btn-pill" onclick="saveBusinessSettings()">Save</button>
          <button class="btn-pill" onclick="closeBusinessSettings()">Close</button>
        </div>

        <hr>
        <div class="small-muted">Delete this business (removes all buildings and units). Type "delete" to confirm.</div>
        <input id="confirmDeleteBiz" placeholder='Type "delete"'>
        <button class="btn-danger btn-pill" onclick="deleteBusinessFromSettings()">Delete business</button>
      </div>

      <!-- Building / Customer Settings -->
      <div id="buildingSettings" style="display:none" class="card">
        <h2>Customer details</h2>
        <div class="card-sub">Used on service sheets and certification for this building.</div>
        <div>
          <div class="settings-section-title">Address &amp; contact</div>
          <label>Address</label>
          <input id="building_address" placeholder="Address">
          <label>Postcode</label>
          <input id="building_postcode" placeholder="Postcode">
          <label>Contact phone</label>
          <input id="building_contactPhone" placeholder="Phone">
          <label>Contact email</label>
          <input id="building_contactEmail" placeholder="Email">

          <div class="settings-section-title" style="margin-top:6px">Maintenance</div>
          <label>Service frequency</label>
          <select id="building_serviceInterval">
            <option value="">Select interval</option>
            <option value="3">3 months</option>
            <option value="6">6 months</option>
            <option value="12">12 months</option>
          </select>
        </div>

        <div style="margin-top:10px" class="controls">
          <button class="btn-primary btn-pill" onclick="saveBuildingSettings()">Save</button>
          <button class="btn-pill" onclick="closeBuildingSettings()">Close</button>
        </div>

        <hr>
        <div class="small-muted">Delete this building. Type "delete" to confirm.</div>
        <input id="confirmDeleteBuilding" placeholder='Type "delete"'>
        <button class="btn-danger btn-pill" onclick="deleteBuildingFromSettings()">Delete building</button>
      </div>

      <!-- User / Engineer Settings -->
      <div id="userSettings" style="display:none" class="card">
        <h2>Your company &amp; engineer</h2>
        <div class="card-sub">Used as the header on both the service sheet and F‑Gas certificate.</div>
        <div>
          <div class="settings-section-title">Company identity</div>
          <label>Your company</label>
          <input id="user_company" placeholder="Trading or common name">
          <label>Company registered name</label>
          <input id="user_company_registered" placeholder="Registered name">
          <label>Trading name</label>
          <input id="user_trading_name" placeholder="Trading name">
          <label>Company registration number</label>
          <input id="user_registration_number" placeholder="Registration number">
          <label>Date of establishment</label>
          <input id="user_date_established" type="date">
          <label>Registered address</label>
          <input id="user_registered_address" placeholder="Registered address / Postcode">

          <div class="settings-section-title">Contact &amp; responsible person</div>
          <label>Your address</label>
          <input id="user_address" placeholder="Address / Postcode">
          <label>Your contact details</label>
          <input id="user_contact" placeholder="Phone / Email">
          <label>Principal contact name</label>
          <input id="user_principal_name" placeholder="Name">
          <label>Principal contact position</label>
          <input id="user_principal_position" placeholder="Position">
          <label>Principal contact email</label>
          <input id="user_principal_email" placeholder="Email">
          <label>Principal contact phone</label>
          <input id="user_principal_phone" placeholder="Phone">
          <label>Scheme contact info (optional)</label>
          <input id="user_scheme_contact" placeholder="Scheme contact">

          <div class="settings-section-title">Engineer &amp; certification</div>
          <label>Your name (Engineer)</label>
          <input id="user_engineer" placeholder="Engineer">
          <label>Personnel qualifications (one per line)</label>
          <textarea id="user_personnel_qualifications" placeholder="e.g. City & Guilds 2079"></textarea>
          <label>Certification scope</label>
          <textarea id="user_certification_scope" placeholder="Scope (installation, servicing, heat pumps, etc.)"></textarea>
          <label>Issuing certification body</label>
          <input id="user_issuing_body" placeholder="e.g. REFCOM">
          <label>Certificate issue date</label>
          <input id="user_certificate_issue" type="date">
          <label>Certificate expiry date</label>
          <input id="user_certificate_expiry" type="date">
          <label>Certificate number (optional)</label>
          <input id="user_certificate_number" placeholder="Certificate number">
          <label>Evidence / Tools / Procedures (optional)</label>
          <textarea id="user_evidence" placeholder="Evidence that the company possesses necessary tools and procedures"></textarea>

          <div class="settings-section-title">Branding</div>
          <label>Logo (PNG/JPG)</label>
          <input id="user_logo_file" type="file" accept="image/*">
          <img id="user_logo_preview" class="logo-preview" style="display:none">
        </div>

        <div style="margin-top:10px" class="controls">
          <button class="btn-primary btn-pill" onclick="saveUserSettings()">Save</button>
          <button class="btn-pill" onclick="closeUserSettings()">Close</button>
        </div>

        <hr>
        <div class="small-muted">Delete all saved data. Type "delete" to confirm.</div>
        <input id="confirmDeleteAll" placeholder='Type "delete"'>
        <button class="btn-danger btn-pill" onclick="deleteAllData()">Delete ALL</button>
      </div>
    </div>
  </main>
</div>

<script>
localforage.config({name:'FgasService'});

const GWP = { 'R22':1810, 'R407':1774, 'R410A':2088, 'R32':675 };

let state = {
  businesses: [],
  currentBusinessId: null,
  currentBuildingId: null,
  user: { company: '', contact: '', engineer: '', address: '', logoDataUrl: '' }
};

async function loadState(){
  const s = await localforage.getItem('state');
  if(s) state = s;
  try{
    const ded = dedupeState(state);
    if(ded.totalRemoved && ded.totalRemoved > 0) console.warn(`loadState: removed ${ded.totalRemoved} duplicate items from state`);
  }catch(e){ console.warn('Error deduping state on load', e); }
  if(!state.user) state.user = { company:'', contact:'', engineer:'', address:'', logoDataUrl: '' };
  state.user.company_registered = state.user.company_registered || '';
  state.user.trading_name = state.user.trading_name || '';
  state.user.registration_number = state.user.registration_number || '';
  state.user.date_established = state.user.date_established || '';
  state.user.registered_address = state.user.registered_address || '';
  state.user.principal_name = state.user.principal_name || '';
  state.user.principal_position = state.user.principal_position || '';
  state.user.principal_email = state.user.principal_email || '';
  state.user.principal_phone = state.user.principal_phone || '';
  state.user.scheme_contact = state.user.scheme_contact || '';
  state.user.personnel_qualifications = state.user.personnel_qualifications || '';
  state.user.certification_scope = state.user.certification_scope || '';
  state.user.issuing_body = state.user.issuing_body || '';
  state.user.certificate_issue = state.user.certificate_issue || '';
  state.user.certificate_expiry = state.user.certificate_expiry || '';
  state.user.certificate_number = state.user.certificate_number || '';
  state.user.evidence = state.user.evidence || '';

  if(state.businesses && Array.isArray(state.businesses)){
    state.businesses.forEach(b=>{
      if(!b.buildings) b.buildings = [];
      b.buildings.forEach(building=>{
        if(building.address === undefined) building.address = '';
        if(building.postcode === undefined) building.postcode = '';
        if(building.contactPhone === undefined) building.contactPhone = '';
        if(building.contactEmail === undefined) building.contactEmail = '';
        if(building.serviceIntervalMonths === undefined) building.serviceIntervalMonths = null;
      });
    });
  }
  render();
}
async function saveState(){ await localforage.setItem('state', state); }

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function findBusiness(id){ return state.businesses.find(b=>b.id===id); }
function findBuilding(biz, id){ return biz.buildings.find(b=>b.id===id); }

function dedupeArrayById(arr, label='items'){
  if(!Array.isArray(arr)) return { arr: [], removed: 0, removedIds: [] };
  const seen = new Set();
  const res = [];
  const removedIds = [];
  arr.forEach(it => {
    const id = it && (it.id || it.cardId || it.ID || it.key);
    if(!id){ res.push(it); return; }
    if(seen.has(id)){ removedIds.push(id); return; }
    seen.add(id);
    res.push(it);
  });
  if(removedIds.length) console.warn(`Dedupe removed ${removedIds.length} duplicate ${label}:`, removedIds);
  return { arr: res, removed: removedIds.length, removedIds };
}

function dedupeState(s){
  if(!s || !Array.isArray(s.businesses)) return { totalRemoved: 0, details: {} };
  let totalRemoved = 0;
  const bizRes = dedupeArrayById(s.businesses, 'businesses');
  s.businesses = bizRes.arr;
  totalRemoved += bizRes.removed;
  s.businesses.forEach(b => {
    if(!Array.isArray(b.buildings)) b.buildings = [];
    const bRes = dedupeArrayById(b.buildings, `buildings for business ${b.id}`);
    b.buildings = bRes.arr;
    totalRemoved += bRes.removed;
    b.buildings.forEach(building => {
      if(!Array.isArray(building.units)) building.units = [];
      const uRes = dedupeArrayById(building.units, `units for building ${building.id}`);
      building.units = uRes.arr;
      totalRemoved += uRes.removed;
    });
  });
  return { totalRemoved, details: { bizRemoved: bizRes.removed } };
}

async function addBusiness(){
  const name = document.getElementById('newBusinessName').value.trim();
  if(!name){ alert('Name required'); return; }
  const b = { id: uid(), name, contact:'', engineer:'', logoDataUrl:'', buildings:[] , created: new Date().toISOString()};
  state.businesses.push(b);
  state.currentBusinessId = b.id;
  state.currentBuildingId = null;
  document.getElementById('newBusinessName').value='';
  await saveState();
  render();
}

async function deleteBusiness(id){
  if(!confirm('Delete business?')) return;
  state.businesses = state.businesses.filter(b=>b.id!==id);
  if(state.currentBusinessId===id){ state.currentBusinessId=null; state.currentBuildingId=null; }
  await saveState();
  render();
}

async function addBuilding(){
  const name = document.getElementById('newBuildingName').value.trim();
  if(!name){ alert('Name required'); return; }
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business first');
  const building = { id: uid(), name, units: [], created: new Date().toISOString(), address:'', postcode:'', contactPhone:'', contactEmail:'', serviceIntervalMonths: null };
  biz.buildings.push(building);
  state.currentBuildingId = building.id;
  document.getElementById('newBuildingName').value='';
  await saveState();
  render();
}

function openBusiness(id){
  state.currentBusinessId = id;
  state.currentBuildingId = null;
  closeBusinessSettings();
  render();
}
function openBuilding(bid){
  state.currentBuildingId = bid;
  render();
}

function calcCO2e(kg, refrigerant){
  const g = (refrigerant && GWP[refrigerant]) ? GWP[refrigerant] : 0;
  return (parseFloat(kg) || 0) * g;
}
function servicesForCO2(co2){
  if(!co2 || co2 === 0) return 1;
  if(co2 < 1000) return 1;
  if(co2 < 5000) return 2;
  if(co2 < 10000) return 3;
  return 4;
}

async function addUnit(type){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business');
  const building = findBuilding(biz, state.currentBuildingId);
  if(!building) return alert('Select a building');

  const u = { id: uid(), type, created: new Date().toISOString() };
  if(type === 'outdoor'){
    u.asset = (document.getElementById('out_asset').value || '').trim();
    u.location = (document.getElementById('out_location').value || '').trim();
    u.model = (document.getElementById('out_model').value || '').trim();
    u.serial = (document.getElementById('out_serial').value || '').trim();
    u.acType = (document.getElementById('out_acType').value || '').trim();
    u.refrigerant = (document.getElementById('out_refrigerant').value || '').trim();
    u.kg = parseFloat(document.getElementById('out_kg').value) || 0;
    u.airOn = parseFloat(document.getElementById('out_airOn').value) || null;
    u.airOff = parseFloat(document.getElementById('out_airOff').value) || null;
    u.tick = !!document.getElementById('out_tick').checked;
    u.note = (document.getElementById('out_note').value || '').trim();
    u.status = (document.getElementById('out_status').value || '');
    u.co2e = calcCO2e(u.kg, u.refrigerant);
    u.servicesPerYear = servicesForCO2(u.co2e);
  } else {
    u.asset = (document.getElementById('in_asset').value || '').trim();
    u.location = (document.getElementById('in_location').value || '').trim();
    u.model = (document.getElementById('in_model').value || '').trim();
    u.serial = (document.getElementById('in_serial').value || '').trim();
    u.acType = (document.getElementById('in_acType').value || '').trim();
    u.linkedOutdoorId = document.getElementById('in_linkedOutdoor') ? (document.getElementById('in_linkedOutdoor').value || null) : null;
    u.airOn = parseFloat(document.getElementById('in_airOn').value) || null;
    u.airOff = parseFloat(document.getElementById('in_airOff').value) || null;
    u.tick = !!document.getElementById('in_tick').checked;
    u.note = (document.getElementById('in_note').value || '').trim();
    u.status = (document.getElementById('in_status').value || '');
    u.co2e = 0;
    u.servicesPerYear = 1;
  }

  building.units.push(u);

  if(type === 'outdoor'){
    ['out_asset','out_location','out_model','out_serial','out_acType','out_refrigerant','out_kg','out_airOn','out_airOff','out_tick','out_note','out_status']
      .forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else el.value=''; });
  } else {
    ['in_asset','in_location','in_model','in_serial','in_acType','in_linkedOutdoor','in_airOn','in_airOff','in_tick','in_note','in_status']
      .forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else el.value=''; });
  }

  await saveState();
  render();
}

async function deleteUnit(unitId){
  const biz = findBusiness(state.currentBusinessId);
  const building = findBuilding(biz, state.currentBuildingId);
  if(!confirm('Delete unit?')) return;
  building.units = building.units.filter(u=>u.id!==unitId);
  await saveState();
  render();
}

async function moveUnit(unitId){
  const biz = findBusiness(state.currentBusinessId);
  const building = findBuilding(biz, state.currentBuildingId);
  const u = building.units.find(x=>x.id===unitId);
  if(!u) return;
  u.type = (u.type === 'indoor') ? 'outdoor' : 'indoor';
  u.co2e = calcCO2e(u.kg || 0, u.refrigerant || '');
  u.servicesPerYear = servicesForCO2(u.co2e);
  await saveState();
  render();
}

function editUnit(unitId){
  const biz = findBusiness(state.currentBusinessId);
  const building = findBuilding(biz, state.currentBuildingId);
  const u = building.units.find(x=>x.id===unitId);
  if(!u) return;

  const container = document.createElement('div');
  container.className = 'unit';
  container.innerHTML = `
    <div style="font-weight:600;margin-bottom:6px;font-size:13px">Edit unit (${escapeHtml(u.type)})</div>
    <div><input id="edit_asset" placeholder="Asset" value="${escapeHtml(u.asset||'')}"></div>
    <div><input id="edit_location" placeholder="Location" value="${escapeHtml(u.location||'')}"></div>
    <div class="flex">
      <input id="edit_model" placeholder="Model" value="${escapeHtml(u.model||'')}">
      <input id="edit_serial" placeholder="Serial" value="${escapeHtml(u.serial||'')}">
    </div>
    ${u.type === 'outdoor' ? `
      <div class="flex">
        <select id="edit_refrigerant">
          <option value="">Refrigerant</option>
          <option ${u.refrigerant==='R22'?'selected':''}>R22</option>
          <option ${u.refrigerant==='R407'?'selected':''}>R407</option>
          <option ${u.refrigerant==='R410A'?'selected':''}>R410A</option>
          <option ${u.refrigerant==='R32'?'selected':''}>R32</option>
        </select>
        <input id="edit_kg" placeholder="kg" type="number" step="any" value="${u.kg||''}">
      </div>
    ` : ''}
    <div class="flex">
      <input id="edit_airOn" placeholder="Air ON °C" type="number" step="any" value="${u.airOn ?? ''}">
      <input id="edit_airOff" placeholder="Air OFF °C" type="number" step="any" value="${u.airOff ?? ''}">
    </div>
    <div class="flex" style="align-items:flex-start">
      <label style="display:flex;align-items:center;font-size:12px">
        <input id="edit_tick" type="checkbox" ${u.tick ? 'checked':''} style="margin-right:6px">Flag issue
      </label>
      <select id="edit_status">
        <option value="">Status</option>
        <option ${u.status==='Pass'?'selected':''}>Pass</option>
        <option ${u.status==='Fail'?'selected':''}>Fail</option>
      </select>
    </div>
    <div><textarea id="edit_note" placeholder="Notes (larger)">${escapeHtml(u.note||'')}</textarea></div>
    <div style="margin-top:6px" class="controls">
      <button id="edit_save" class="btn-primary btn-pill">Save</button>
      <button id="edit_cancel" class="btn-pill">Cancel</button>
    </div>
  `;

  const lists = document.querySelectorAll('#outdoorList .unit, #indoorList .unit');
  let replaced = false;
  lists.forEach(el => {
    if(!replaced && el.querySelector('div strong') && el.querySelector('div strong').textContent === (u.asset || u.model || 'Unit')){
      el.replaceWith(container);
      replaced = true;
    }
  });
  if(!replaced) {
    render();
    return;
  }

  document.getElementById('edit_cancel').onclick = ()=>{ render(); };

  const editLinked = document.getElementById('edit_linkedOutdoor');
  if(editLinked){
    editLinked.innerHTML = '<option value="">None</option>';
    building.units.filter(x=>x.type==='outdoor').forEach(o=>{
      const opt = document.createElement('option'); opt.value = o.id; opt.textContent = `${o.asset || o.model || o.location || 'Outdoor'}`;
      editLinked.appendChild(opt);
    });
    if(u.linkedOutdoorId) editLinked.value = u.linkedOutdoorId;
  }

  document.getElementById('edit_save').onclick = async ()=>{
    u.asset = document.getElementById('edit_asset').value.trim();
    u.location = document.getElementById('edit_location').value.trim();
    u.model = document.getElementById('edit_model') ? document.getElementById('edit_model').value.trim() : u.model;
    u.serial = document.getElementById('edit_serial') ? document.getElementById('edit_serial').value.trim() : u.serial;
    if(u.type === 'outdoor'){
      u.refrigerant = document.getElementById('edit_refrigerant').value.trim();
      u.kg = parseFloat(document.getElementById('edit_kg').value) || 0;
    }
    const on = parseFloat(document.getElementById('edit_airOn').value);
    const off = parseFloat(document.getElementById('edit_airOff').value);
    u.airOn = isNaN(on) ? null : on;
    u.airOff = isNaN(off) ? null : off;
    u.acType = document.getElementById('edit_acType') ? document.getElementById('edit_acType').value.trim() : u.acType;
    u.linkedOutdoorId = document.getElementById('edit_linkedOutdoor') ? (document.getElementById('edit_linkedOutdoor').value || null) : u.linkedOutdoorId || null;
    u.tick = !!document.getElementById('edit_tick').checked;
    u.note = document.getElementById('edit_note').value.trim();
    u.status = document.getElementById('edit_status').value;
    u.co2e = calcCO2e(u.kg || 0, u.refrigerant || '');
    u.servicesPerYear = servicesForCO2(u.co2e);
    await saveState();
    render();
  };
}

async function exportJSON(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fgas-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function importJSON(){
  const inp = document.getElementById('importFile');
  if(!inp.files || !inp.files[0]) return alert('Select a JSON file first');
  const text = await inp.files[0].text();
  try{
    const parsed = JSON.parse(text);
    if(!parsed || !Array.isArray(parsed.businesses)) return alert('Invalid backup format');
    try{
      const ded = dedupeState(parsed);
      if(ded.totalRemoved && ded.totalRemoved > 0) alert(`Import cleaned: removed ${ded.totalRemoved} duplicate items from backup`);
    }catch(e){ console.warn('Error deduping imported backup', e); }
    state = parsed;
    await saveState();
    render();
    alert('Import complete');
  }catch(e){ alert('Invalid JSON'); }
}

async function deleteAllData(){
  const v = document.getElementById('confirmDeleteAll').value.trim();
  if(v !== 'delete') return alert('Type delete to confirm');
  await localforage.clear();
  state = {businesses:[], currentBusinessId:null, currentBuildingId:null, user: { company: '', contact: '', engineer: '', address: '', logoDataUrl: '' }};
  document.getElementById('confirmDeleteAll').value = '';
  render();
}

function openBusinessSettings(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business first');
  document.getElementById('businessSettings').style.display = 'block';
  document.getElementById('businessView').style.display = 'none';
  document.getElementById('businessSettings').scrollIntoView();
  document.getElementById('biz_name').value = biz.name || '';
  document.getElementById('biz_contact').value = biz.contact || '';
  document.getElementById('biz_engineer').value = biz.engineer || '';
  if(biz.logoDataUrl){
    const img = document.getElementById('biz_logo_preview');
    img.src = biz.logoDataUrl;
    img.style.display = 'block';
  } else {
    document.getElementById('biz_logo_preview').style.display = 'none';
  }
}
function closeBusinessSettings(){
  document.getElementById('businessSettings').style.display = 'none';
  document.getElementById('businessView').style.display = 'block';
}

async function saveBusinessSettings(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return;
  biz.name = document.getElementById('biz_name').value.trim();
  biz.contact = document.getElementById('biz_contact').value.trim();
  biz.engineer = document.getElementById('biz_engineer').value.trim();
  const f = document.getElementById('biz_logo_file').files[0];
  if(f){
    const data = await f.arrayBuffer();
    const blob = new Blob([data], {type: f.type});
    const reader = new FileReader();
    reader.onload = async ()=> {
      biz.logoDataUrl = reader.result;
      await saveState();
      closeBusinessSettings();
      render();
    };
    reader.readAsDataURL(blob);
  } else {
    await saveState();
    closeBusinessSettings();
    render();
  }
}

async function deleteBusinessFromSettings(){
  const v = document.getElementById('confirmDeleteBiz').value.trim();
  if(v !== 'delete') return alert('Type delete to confirm');
  const id = state.currentBusinessId;
  state.businesses = state.businesses.filter(b=>b.id!==id);
  state.currentBusinessId = null;
  state.currentBuildingId = null;
  document.getElementById('confirmDeleteBiz').value = '';
  await saveState();
  render();
}

function openBuildingSettings(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business first');
  const building = findBuilding(biz, state.currentBuildingId);
  if(!building) return alert('Select a building first');
  document.getElementById('buildingSettings').style.display = 'block';
  document.getElementById('buildingView').style.display = 'none';
  document.getElementById('buildingSettings').scrollIntoView();
  document.getElementById('building_address').value = building.address || '';
  document.getElementById('building_postcode').value = building.postcode || '';
  document.getElementById('building_contactPhone').value = building.contactPhone || '';
  document.getElementById('building_contactEmail').value = building.contactEmail || '';
  document.getElementById('building_serviceInterval').value = building.serviceIntervalMonths || '';
}
function closeBuildingSettings(){
  document.getElementById('buildingSettings').style.display = 'none';
  document.getElementById('buildingView').style.display = 'block';
}
async function saveBuildingSettings(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) { alert('Select a business first'); return; }
  const building = findBuilding(biz, state.currentBuildingId);
  if(!building) { alert('Select a building first'); return; }

  const addrEl = document.getElementById('building_address');
  const postEl = document.getElementById('building_postcode');
  const phoneEl = document.getElementById('building_contactPhone');
  const emailEl = document.getElementById('building_contactEmail');
  const siEl = document.getElementById('building_serviceInterval');
  if(!siEl){ alert('Service interval control not found in DOM'); return; }

  building.address = addrEl ? addrEl.value.trim() : '';
  building.postcode = postEl ? postEl.value.trim() : '';
  building.contactPhone = phoneEl ? phoneEl.value.trim() : '';
  building.contactEmail = emailEl ? emailEl.value.trim() : '';

  const siRaw = siEl.value;
  const si = parseInt(siRaw);
  building.serviceIntervalMonths = isNaN(si) ? null : si;

  console.log('saveBuildingSettings:', { buildingId: building.id, serviceIntervalMonths: building.serviceIntervalMonths, siRaw });
  await saveState();
  closeBuildingSettings();
  render();
  alert('Building settings saved');
}
async function deleteBuildingFromSettings(){
  const v = document.getElementById('confirmDeleteBuilding').value.trim();
  if(v !== 'delete') return alert('Type delete to confirm');
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return;
  const id = state.currentBuildingId;
  biz.buildings = biz.buildings.filter(b=>b.id!==id);
  state.currentBuildingId = null;
  document.getElementById('confirmDeleteBuilding').value = '';
  await saveState();
  render();
}

function openUserSettings(){
  document.getElementById('userSettings').style.display = 'block';
  document.getElementById('businessView').style.display = 'none';
  document.getElementById('userSettings').scrollIntoView();
  document.getElementById('user_company').value = state.user.company || '';
  document.getElementById('user_company_registered').value = state.user.company_registered || '';
  document.getElementById('user_trading_name').value = state.user.trading_name || '';
  document.getElementById('user_registration_number').value = state.user.registration_number || '';
  document.getElementById('user_date_established').value = state.user.date_established || '';
  document.getElementById('user_registered_address').value = state.user.registered_address || '';

  document.getElementById('user_address').value = state.user.address || '';
  document.getElementById('user_contact').value = state.user.contact || '';
  document.getElementById('user_principal_name').value = state.user.principal_name || '';
  document.getElementById('user_principal_position').value = state.user.principal_position || '';
  document.getElementById('user_principal_email').value = state.user.principal_email || '';
  document.getElementById('user_principal_phone').value = state.user.principal_phone || '';
  document.getElementById('user_scheme_contact').value = state.user.scheme_contact || '';
  document.getElementById('user_engineer').value = state.user.engineer || '';
  document.getElementById('user_personnel_qualifications').value = state.user.personnel_qualifications || '';
  document.getElementById('user_certification_scope').value = state.user.certification_scope || '';
  document.getElementById('user_issuing_body').value = state.user.issuing_body || '';
  document.getElementById('user_certificate_issue').value = state.user.certificate_issue || '';
  document.getElementById('user_certificate_expiry').value = state.user.certificate_expiry || '';
  document.getElementById('user_certificate_number').value = state.user.certificate_number || '';
  document.getElementById('user_evidence').value = state.user.evidence || '';
  if(state.user.logoDataUrl){
    const img = document.getElementById('user_logo_preview');
    img.src = state.user.logoDataUrl;
    img.style.display = 'block';
  } else {
    document.getElementById('user_logo_preview').style.display = 'none';
  }
}
function closeUserSettings(){
  document.getElementById('userSettings').style.display = 'none';
  document.getElementById('businessView').style.display = 'block';
}
async function saveUserSettings(){
  state.user.company = document.getElementById('user_company').value.trim();
  state.user.company_registered = document.getElementById('user_company_registered').value.trim();
  state.user.trading_name = document.getElementById('user_trading_name').value.trim();
  state.user.registration_number = document.getElementById('user_registration_number').value.trim();
  state.user.date_established = document.getElementById('user_date_established').value || '';
  state.user.registered_address = document.getElementById('user_registered_address').value.trim();

  state.user.address = document.getElementById('user_address').value.trim();
  state.user.contact = document.getElementById('user_contact').value.trim();
  state.user.principal_name = document.getElementById('user_principal_name').value.trim();
  state.user.principal_position = document.getElementById('user_principal_position').value.trim();
  state.user.principal_email = document.getElementById('user_principal_email').value.trim();
  state.user.principal_phone = document.getElementById('user_principal_phone').value.trim();
  state.user.scheme_contact = document.getElementById('user_scheme_contact').value.trim();
  state.user.engineer = document.getElementById('user_engineer').value.trim();
  state.user.personnel_qualifications = document.getElementById('user_personnel_qualifications').value.trim();
  state.user.certification_scope = document.getElementById('user_certification_scope').value.trim();
  state.user.issuing_body = document.getElementById('user_issuing_body').value.trim();
  state.user.certificate_issue = document.getElementById('user_certificate_issue').value || '';
  state.user.certificate_expiry = document.getElementById('user_certificate_expiry').value || '';
  state.user.certificate_number = document.getElementById('user_certificate_number').value.trim();
  state.user.evidence = document.getElementById('user_evidence').value.trim();
  const f = document.getElementById('user_logo_file').files[0];
  if(f){
    const data = await f.arrayBuffer();
    const blob = new Blob([data], {type: f.type});
    const reader = new FileReader();
    reader.onload = async ()=> {
      state.user.logoDataUrl = reader.result;
      await saveState();
      closeUserSettings();
      render();
    };
    reader.readAsDataURL(blob);
  } else {
    await saveState();
    closeUserSettings();
    render();
  }
}

function render(){
  const bl = document.getElementById('businessList');
  bl.innerHTML = '';
  state.businesses.forEach(b=>{
    const d = document.createElement('div');
    d.className='list-item';
    const left = document.createElement('div');
    left.style.flex='1';
    left.innerHTML = `<div style="font-weight:600;font-size:13px">${escapeHtml(b.name)}</div><div class="small-muted">${b.buildings.length} building(s)</div>`;
    left.onclick = ()=>openBusiness(b.id);
    const right = document.createElement('div');
    const chip = document.createElement('span');
    chip.className='chip';
    chip.textContent = 'Open';
    chip.onclick = (e)=>{ e.stopPropagation(); openBusiness(b.id); };
    right.appendChild(chip);
    d.appendChild(left);
    d.appendChild(right);
    bl.appendChild(d);
  });

  const bizView = document.getElementById('businessView');
  if(!state.currentBusinessId){
    bizView.style.display='none';
    document.getElementById('businessSettings').style.display='none';
    document.getElementById('emptyMsg').style.display='block';
    return;
  }
  document.getElementById('emptyMsg').style.display='none';
  document.getElementById('businessSettings').style.display='none';
  bizView.style.display='block';
  const biz = findBusiness(state.currentBusinessId);
  document.getElementById('businessTitle').textContent = biz.name;
  document.getElementById('businessInfo').textContent = `Created: ${biz.created}`;
  document.getElementById('businessContact').textContent = biz.contact ? `Contact: ${biz.contact}` : '';
  document.getElementById('businessEngineer').textContent = biz.engineer ? `Engineer: ${biz.engineer}` : '';
  const logoWrap = document.getElementById('businessLogoWrap');
  logoWrap.innerHTML = '';
  if(biz.logoDataUrl){
    const img = document.createElement('img');
    img.src = biz.logoDataUrl;
    img.className = 'logo-preview';
    logoWrap.appendChild(img);
  }

  const bList = document.getElementById('buildingList');
  bList.innerHTML = '';
  biz.buildings.forEach(b=>{
    const el = document.createElement('div');
    el.className='list-item';
    const left = document.createElement('div');
    left.style.flex='1';
    left.innerHTML = `<div style="font-weight:600;font-size:13px">${escapeHtml(b.name)}</div><div class="small-muted">${b.units.length} unit(s)</div>`;
    left.onclick = ()=>openBuilding(b.id);
    const right = document.createElement('div');
    const btnOpen = document.createElement('button'); btnOpen.textContent='Open'; btnOpen.className='btn-pill';
    btnOpen.onclick = (e)=>{ e.stopPropagation(); openBuilding(b.id); };
    right.appendChild(btnOpen);
    el.appendChild(left); el.appendChild(right);
    bList.appendChild(el);
  });

  if(!state.currentBuildingId){
    document.getElementById('buildingView').style.display='none';
    return;
  }
  document.getElementById('buildingView').style.display='block';
  const building = findBuilding(biz, state.currentBuildingId);
  document.getElementById('buildingTitle').textContent = building.name;
  let bInfo = `Created: ${building.created}`;
  if(building.address) bInfo += ` — ${building.address}${building.postcode ? ' ' + building.postcode : ''}`;
  if(building.contactPhone || building.contactEmail) bInfo += ` — Contact: ${building.contactPhone || ''}${building.contactEmail ? ' / ' + building.contactEmail : ''}`;
  if(building.serviceIntervalMonths) bInfo += ` — Service frequency: ${building.serviceIntervalMonths} months`;
  document.getElementById('buildingInfo').textContent = bInfo;

  const bizBtn = document.getElementById('bizSettingsBtn');
  if(bizBtn) bizBtn.style.display = (state.businesses && state.businesses.length > 0) ? 'none' : 'inline-flex';

  const linkedSel = document.getElementById('in_linkedOutdoor');
  if(linkedSel){
    linkedSel.innerHTML = '<option value="">None</option>';
    building.units.filter(x=>x.type==='outdoor').forEach(o=>{
      const opt = document.createElement('option'); opt.value = o.id; opt.textContent = `${o.asset || o.model || o.location || 'Outdoor'}`;
      linkedSel.appendChild(opt);
    });
  }

  const outList = document.getElementById('outdoorList'); outList.innerHTML='';
  const inList = document.getElementById('indoorList'); inList.innerHTML='';

  building.units.forEach(u=>{
    const el = document.createElement('div'); el.className='unit';
    const header = document.createElement('div');
    header.className = 'unit-header';
    header.innerHTML = `
      <div><strong>${escapeHtml(u.asset || (u.model||u.location||'Unit'))}</strong></div>
      <div style="display:flex;align-items:center;gap:6px">
        <span class="unit-type-pill">${u.type}</span>
        <span class="small-muted">${u.servicesPerYear} srv/yr</span>
      </div>
    `;
    el.appendChild(header);

    const rows = document.createElement('div'); rows.className='unit-body';
    const left = document.createElement('div'); left.className='unit-col';
    left.innerHTML = `
      <div class="note"><strong>Location:</strong> ${escapeHtml(u.location||'')}</div>
      <div class="note"><strong>Model:</strong> ${escapeHtml(u.model||'')} <strong>Serial:</strong> ${escapeHtml(u.serial||'')}</div>
      <div class="note"><strong>AC type:</strong> ${escapeHtml(u.acType||'')}</div>
      <div class="note"><strong>Asset:</strong> ${escapeHtml(u.asset||'')}</div>
      ${u.type !== 'outdoor' ? `<div class="note"><strong>Linked outdoor:</strong> ${ escapeHtml((building.units.find(x=>x.id===u.linkedOutdoorId)||{}).asset || '') }</div>` : ''}
      <div class="note"><strong>Refrigerant:</strong> ${escapeHtml(u.refrigerant||'')} ${u.kg ? ` · ${u.kg} kg` : ''} ${u.co2e ? ` · CO2e ${Math.round(u.co2e)}` : ''}</div>
      <div class="note"><strong>Air ON:</strong> ${u.airOn ?? ''} · <strong>Air OFF:</strong> ${u.airOff ?? ''} ${(u.airOn!=null && u.airOff!=null) ? `<strong>Δ:</strong> ${(u.airOn - u.airOff)} °C` : ''}</div>
      <div class="note"><strong>Next due:</strong> ${formatDate(getNextDueDate(u, building))} ${(building.serviceIntervalMonths || u.serviceIntervalMonths) ? `(${building.serviceIntervalMonths || u.serviceIntervalMonths} months)` : ''}</div>
      <div class="note"><strong>Flagged:</strong> ${u.tick ? 'Yes' : 'No'} · <strong>Status:</strong> ${u.status || ''}</div>
      <div style="margin-top:4px"><strong style="font-size:11px">Notes:</strong><div class="note">${escapeHtml(u.note || '')}</div></div>
    `;
    rows.appendChild(left);

    const right = document.createElement('div');
    right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='5px';
    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.className='btn-pill'; btnEdit.onclick = ()=>editUnit(u.id);
    const btnMove = document.createElement('button'); btnMove.textContent='Move'; btnMove.className='btn-pill'; btnMove.onclick = ()=>{ if(confirm('Move unit to other type (indoor/outdoor)?')) moveUnit(u.id); };
    const btnDelete = document.createElement('button'); btnDelete.className='btn-danger btn-pill'; btnDelete.textContent='Delete'; btnDelete.onclick = ()=>deleteUnit(u.id);
    right.appendChild(btnEdit); right.appendChild(btnMove); right.appendChild(btnDelete);
    rows.appendChild(right);

    el.appendChild(rows);

    if(u.type === 'outdoor') outList.appendChild(el); else inList.appendChild(el);
  });
}

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function monthsForServicesPerYear(n){
  if(!n || n <= 0) return 12;
  return Math.round(12 / n);
}
function addTextLine(doc, text, x, y, options){
  doc.text(String(text), x, y, options);
  return y + 5;
}
function formatDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleDateString(); }
function getNextDueDate(u, building){
  const months = (building && building.serviceIntervalMonths) || u.serviceIntervalMonths || monthsForServicesPerYear(u.servicesPerYear || 1);
  const d = new Date();
  d.setMonth(d.getMonth() + months);
  return d;
}

async function addLogoToDoc(doc, dataUrl, x=150, y=8, maxW=40, maxH=20){
  if(!dataUrl) return;
  const img = new Image();
  const p = new Promise(res=>{ img.onload = res; img.onerror = res; img.src = dataUrl; });
  await p;
  if(!img.width) return;
  let w = img.width, h = img.height;
  const ratio = Math.min(maxW / w, maxH / h, 1);
  w = w * ratio;
  h = h * ratio;
  try{ doc.addImage(img, 'PNG', x, y, w, h); }catch(e){}
}

/* DETAILED SERVICE SHEET PDF WITH WRAPPED DECLARATION */
async function exportServiceReportPDF(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business');
  const building = findBuilding(biz, state.currentBuildingId);
  if(!building) return alert('Select a building');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  function drawPageBorder(){
    doc.setLineWidth(0.4);
    doc.setDrawColor(0);
    doc.rect(8, 8, 194, 281);
  }
  drawPageBorder();

  let y = 14;
  await addLogoToDoc(doc, state.user.logoDataUrl || biz.logoDataUrl, 164, 10, 36, 18);

  const headerName = state.user.company || biz.name || '';
  doc.setFont('helvetica','bold');
  doc.setFontSize(14); y = addTextLine(doc, headerName, 12, y);
  doc.setFont('helvetica','normal');
  doc.setFontSize(10); y = addTextLine(doc, 'Air Conditioning & Refrigeration Service Report', 12, y);

  const engineer = state.user.engineer || biz.engineer || '';
  y = addTextLine(doc, `Engineer: ${engineer || ''}`, 12, y);
  y = addTextLine(doc, `Report date: ${new Date().toLocaleDateString()}`, 12, y);
  y += 2;

  doc.setFont('helvetica','bold'); doc.setFontSize(11);
  y = addTextLine(doc, 'Customer / Site details', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  const addrLine = `${building.name}${building.address ? ', ' + building.address : ''}${building.postcode ? ', ' + building.postcode : ''}`;
  y = addTextLine(doc, `Site: ${addrLine}`, 12, y);
  const contactLine = `${building.contactPhone || ''}${building.contactEmail ? ' / ' + building.contactEmail : ''}`;
  y = addTextLine(doc, `Contact: ${contactLine || 'Not specified'}`, 12, y);
  if(building.serviceIntervalMonths){
    y = addTextLine(doc, `Service interval: ${building.serviceIntervalMonths} months`, 12, y);
  }
  y += 3;

  let earliest = null;
  building.units.forEach(u=>{ const nd = getNextDueDate(u, building); if(!earliest || nd < earliest) earliest = nd; });
  if(earliest){
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    y = addTextLine(doc, `Next planned service (earliest unit): ${formatDate(earliest)}`, 12, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
  }
  y += 3;

  doc.setFont('helvetica','bold');
  doc.setFontSize(10);
  y = addTextLine(doc, 'Summary of equipment', 12, y);
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);

  let totalKg = 0, totalCO2 = 0, flagged = 0, fails = 0;
  building.units.forEach(u=>{
    totalKg += (u.kg || 0);
    totalCO2 += (u.co2e || 0);
    if(u.tick) flagged++;
    if(u.status === 'Fail') fails++;
  });
  y = addTextLine(doc, `Units: ${building.units.length} · Total charge: ${totalKg.toFixed(2)} kg · Total CO2e: ${Math.round(totalCO2)} kg`, 12, y);
  y = addTextLine(doc, `Flagged units: ${flagged} · Failed status: ${fails}`, 12, y);
  y += 4;

  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Service details by unit', 12, y);
  y += 1;

  function maybeNewPage(){
    if(y > 270){
      doc.addPage();
      drawPageBorder();
      y = 14;
      doc.setFont('helvetica','bold'); doc.setFontSize(10);
      y = addTextLine(doc, 'Service details by unit (cont.)', 12, y);
      y += 1;
    }
  }

  building.units.forEach((u, idx)=>{
    maybeNewPage();
    doc.setFont('helvetica','bold'); doc.setFontSize(9);
    const title = `${idx+1}. ${u.asset || u.model || 'Unit'} (${u.type})`;
    y = addTextLine(doc, title, 12, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(8);

    const detailLines = [
      `Location: ${u.location || '-'}`,
      `Model: ${u.model || '-'}   Serial: ${u.serial || '-'}`,
      `AC type: ${u.acType || '-'}`,
      `Refrigerant: ${u.refrigerant || 'N/A'}   Charge: ${(u.kg || 0)} kg   CO2e: ${u.co2e ? Math.round(u.co2e) : 0}`,
      `Air ON: ${u.airOn ?? '-'} °C   Air OFF: ${u.airOff ?? '-'} °C   ΔT: ${(u.airOn!=null && u.airOff!=null) ? (u.airOn-u.airOff) : '-' }`,
      `Service frequency: ${(building.serviceIntervalMonths || u.serviceIntervalMonths || monthsForServicesPerYear(u.servicesPerYear || 1))} months`,
      `Next due: ${formatDate(getNextDueDate(u, building))}`,
      `Status: ${u.status || 'Not recorded'}   Flagged: ${u.tick ? 'Yes' : 'No'}`
    ];
    detailLines.forEach(line=>{
      y = addTextLine(doc, line, 14, y);
    });

    if(u.note){
      y = addTextLine(doc, `Notes / work carried out:`, 14, y);
      const maxWidth = 180;
      const splitted = doc.splitTextToSize(u.note, maxWidth);
      splitted.forEach(t=>{
        y = addTextLine(doc, t, 16, y);
      });
    }
    y += 2;
  });

  maybeNewPage();
  y += 3;
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Engineer declaration', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(8);

  const declText = 'All work has been completed in accordance with F‑Gas regulations, manufacturer instructions.';
  const declLines = doc.splitTextToSize(declText, 170);
  declLines.forEach(line => {
    y = addTextLine(doc, line, 12, y);
  });

  y += 4;
  doc.setFontSize(8);
  y = addTextLine(doc, `Engineer name: ${state.user.engineer || biz.engineer || ''}`, 12, y);
  y = addTextLine(doc, 'Signature: ____________________________', 12, y);
  y = addTextLine(doc, 'Date: _____________________', 120, y);

  doc.save(`${biz.name}_${building.name}_service-report.pdf`);
}

/* MORE FORMAL F-GAS CERT PDF WITH WRAPPED REGULATORY STATEMENT */
async function exportFGasCertificatePDF(){
  const biz = findBusiness(state.currentBusinessId);
  if(!biz) return alert('Select a business');
  const building = findBuilding(biz, state.currentBuildingId);
  if(!building) return alert('Select a building');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 14;

  doc.setLineWidth(0.4);
  doc.setDrawColor(0);
  doc.rect(8, 8, 194, 281);

  await addLogoToDoc(doc, state.user.logoDataUrl || biz.logoDataUrl, 164, 10, 36, 18);

  const headerName = state.user.company_registered || state.user.company || biz.name || '';
  const cx = 105;

  doc.setFont('helvetica','bold');
  doc.setFontSize(14);
  y = addTextLine(doc, headerName, cx, y, {align: 'center'});
  doc.setFont('helvetica','normal');
  doc.setFontSize(10);
  y = addTextLine(doc, state.user.registered_address || state.user.address || '', cx, y, {align: 'center'});
  y = addTextLine(doc, `Company registration: ${state.user.registration_number || 'N/A'}`, cx, y, {align: 'center'});
  y += 3;

  doc.setFont('helvetica','bold'); doc.setFontSize(13);
  y = addTextLine(doc, 'F-Gas Company Certificate', cx, y, {align: 'center'});
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  y = addTextLine(doc, 'Certificate of company competence for stationary refrigeration, air conditioning and/or heat pump equipment', cx, y, {align: 'center'});
  y += 4;

  const engineer = state.user.engineer || biz.engineer || '';
  y = addTextLine(doc, `Engineer responsible: ${engineer || 'Not specified'}`, cx, y, {align: 'center'});
  y = addTextLine(doc, `Date of issue (this document): ${new Date().toLocaleDateString()}`, cx, y, {align: 'center'});
  y += 4;

  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Company certification details', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  y = addTextLine(doc, `Registered name: ${state.user.company_registered || state.user.company || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Trading name: ${state.user.trading_name || state.user.company || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Registered address: ${state.user.registered_address || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Date established: ${state.user.date_established || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Issuing certification body: ${state.user.issuing_body || 'REFCOM'}`, 12, y);
  y = addTextLine(doc, `Certificate number: ${state.user.certificate_number || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Certificate issue date: ${state.user.certificate_issue || 'Not set'}`, 12, y);
  y = addTextLine(doc, `Certificate expiry date: ${state.user.certificate_expiry || 'Not set'}`, 12, y);
  y += 2;

  if(state.user.certification_scope){
    const scopeLines = doc.splitTextToSize(state.user.certification_scope, 180);
    y = addTextLine(doc, 'Scope of certification:', 12, y);
    scopeLines.forEach(line=>{
      y = addTextLine(doc, line, 16, y);
    });
    y += 2;
  }

  if(state.user.personnel_qualifications){
    const quals = state.user.personnel_qualifications.split('\n').filter(Boolean);
    y = addTextLine(doc, 'Personnel qualifications:', 12, y);
    quals.forEach(q=>{
      y = addTextLine(doc, `• ${q}`, 16, y);
    });
    y += 2;
  }

  if(state.user.evidence){
    const evidenceLines = doc.splitTextToSize(state.user.evidence, 180);
    y = addTextLine(doc, 'Evidence of tools, equipment and procedures:', 12, y);
    evidenceLines.forEach(line=>{
      y = addTextLine(doc, line, 16, y);
    });
    y += 2;
  }

  y += 3;
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Customer / Site covered by this record', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  const buildingAddr = `${building.name}${building.address ? ', ' + building.address : ''}${building.postcode ? ', ' + building.postcode : ''}`;
  y = addTextLine(doc, `Site: ${buildingAddr}`, 12, y);
  y = addTextLine(doc, `Contact: ${(building.contactPhone || '') + (building.contactEmail ? ' / ' + building.contactEmail : '')}`, 12, y);
  if(building.serviceIntervalMonths){
    y = addTextLine(doc, `Service interval: ${building.serviceIntervalMonths} months`, 12, y);
  }
  y += 3;

  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Refrigerant inventory on site', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(9);

  let totalKg = 0; let totalCO2 = 0;
  building.units.forEach(u=>{ totalKg += (u.kg || 0); totalCO2 += (u.co2e || 0); });

  y = addTextLine(doc, `Units serviced: ${building.units.length}`, 12, y);
  y = addTextLine(doc, `Total refrigerant charge: ${totalKg.toFixed(2)} kg`, 12, y);
  y = addTextLine(doc, `Total calculated CO2e: ${Math.round(totalCO2)} kg CO2e`, 12, y);
  y += 2;

  doc.setFont('helvetica','bold'); doc.setFontSize(9);
  y = addTextLine(doc, 'Unit list (charge and CO2e)', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(8);

  function maybeNewPageCert(){
    if(y > 270){
      doc.addPage();
      doc.setLineWidth(0.4);
      doc.setDrawColor(0);
      doc.rect(8, 8, 194, 281);
      y = 14;
      doc.setFont('helvetica','bold'); doc.setFontSize(9);
      y = addTextLine(doc, 'Unit list (continued)', 12, y);
      doc.setFont('helvetica','normal'); doc.setFontSize(8);
    }
  }

  building.units.forEach(u=>{
    maybeNewPageCert();
    const line = `${u.asset || u.model || 'Unit'} (${u.type})  –  ${u.refrigerant || 'N/A'}  ·  ${(u.kg || 0)} kg  ·  CO2e: ${u.co2e ? Math.round(u.co2e) : 0}  ·  Status: ${u.status || 'N/A'}`;
    y = addTextLine(doc, `• ${line}`, 12, y);
  });

  y += 4;
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  y = addTextLine(doc, 'Regulatory statement', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(8);

  const regText1 = 'This company is certified to handle fluorinated greenhouse gases in accordance with EC Regulation 517/2014 (F-Gas Regulation) and the relevant implementing UK instrument.';
  const regLines1 = doc.splitTextToSize(regText1, 180);
  regLines1.forEach(line=>{
    y = addTextLine(doc, line, 12, y);
  });

  const regText2 = 'This record summarises the equipment and refrigerant charge for the site named above and should be read with any maintenance reports issued for the same visit.';
  const regLines2 = doc.splitTextToSize(regText2, 180);
  regLines2.forEach(line=>{
    y = addTextLine(doc, line, 12, y);
  });

  y += 4;
  doc.setFont('helvetica','bold'); doc.setFontSize(9);
  y = addTextLine(doc, 'Authorisation', 12, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(8);
  y = addTextLine(doc, `Authorised signatory: ${state.user.principal_name || engineer || ''}`, 12, y);
  y = addTextLine(doc, 'Signature: ____________________________    Date: _____________________', 12, y);

  doc.save(`${(state.user.company || biz.name)}_${building.name}_fgas-certificate.pdf`);
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('biz_logo_file').addEventListener('change', function(e){
    const f = this.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = document.getElementById('biz_logo_preview');
      img.src = reader.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(f);
  });

  document.getElementById('user_logo_file').addEventListener('change', function(e){
    const f = this.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = document.getElementById('user_logo_preview');
      img.src = reader.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(f);
  });

  loadState();
});
</script>
</body>
</html>
